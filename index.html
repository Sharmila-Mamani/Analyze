<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python Data Processing & CI/CD Solution</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f8f9fa;
        }
        .container {
            max-width: 960px;
            margin-top: 30px;
            margin-bottom: 30px;
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        h1, h2, h3 {
            color: #0056b3;
            margin-bottom: 20px;
        }
        pre {
            background-color: #f4f4f4;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            border: 1px solid #ddd;
        }
        code {
            font-family: 'Fira Code', 'Cascadia Code', 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
        }
        .section-separator {
            border-top: 1px dashed #e0e0e0;
            margin: 40px 0;
        }
        .alert {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center">Python Data Processing & CI/CD Solution</h1>
        <p class="lead text-center">This document outlines the solution for the data processing task, including the fixed Python script, the converted data, and the GitHub Actions workflow for continuous integration and deployment.</p>

        <div class="section-separator"></div>

        <h2>1. Fixed <code>execute.py</code> Script</h2>
        <p>The Python script <code>execute.py</code> has been fixed to address two non-trivial errors:</p>
        <ol>
            <li>Corrected the typo "revenew" to "revenue" in the daily revenue calculation.</li>
            <li>Updated the data source from <code>data.xlsx</code> to <code>data.csv</code>, as per the brief's requirement to convert and commit <code>data.csv</code>.</li>
        </ol>
        <pre><code class="language-python">import json

import pandas as pd


def main():
    # Read the data from data.csv
    df = pd.read_csv("data.csv")

    # Compute revenue
    df["revenue"] = df["units"] * df["price"]

    # row_count
    row_count = len(df)

    # regions: count of distinct regions
    regions_count = df["region"].nunique()

    # top_n_products_by_revenue (n=3)
    n = 3
    top_products = (
        df.groupby("product")["revenue"]
        .sum()
        .sort_values(ascending=False)
        .head(n)
        .reset_index()
    )
    top_products_list = [
        {"product": row["product"], "revenue": float(row["revenue"])}
        for _, row in top_products.iterrows()
    ]

    # rolling_7d_revenue_by_region: for each region, last value of 7-day moving average of daily revenue
    df["date"] = pd.to_datetime(df["date"])  # ensure datetime
    daily_rev = (
        df.groupby(["region", "date"])["revenue"]  # daily revenue per region - FIXED TYPO
        .sum()
        .reset_index()
        .sort_values(["region", "date"])  # ensure sorted for rolling
    )

    # Compute 7-day rolling mean of revenue per region, retaining the region column
    rolling = (
        daily_rev.groupby("region")
        .apply(lambda g: g.set_index("date")["revenue"].rolling("7D").mean(), include_groups=False)
        .reset_index(name="rolling_7d_revenue")
    )

    last_rolling = (
        rolling.sort_values(["region", "date"])  # ensure order
        .groupby("region")
        .tail(1)
    )

    rolling_summary = {
        row["region"]: float(row["rolling_7d_revenue"]) for _, row in last_rolling.iterrows()
    }

    result = {
        "row_count": int(row_count),
        "regions": int(regions_count),
        "top_n_products_by_revenue": top_products_list,
        "rolling_7d_revenue_by_region": rolling_summary,
    }

    print(json.dumps(result, indent=2))


if __name__ == "__main__":
    main()</code></pre>

        <div class="section-separator"></div>

        <h2>2. Converted <code>data.csv</code> Content</h2>
        <p>The <code>data.xlsx</code> attachment has been converted to <code>data.csv</code>. This CSV file is committed to the repository and is the input for <code>execute.py</code>.</p>
        <pre><code class="language-csv">date,region,product,units,price
2023-01-01,East,A,100,10.5
2023-01-01,West,B,150,12.0
2023-01-02,East,A,120,10.5
2023-01-02,Central,C,80,25.0
2023-01-03,West,B,130,12.0
2023-01-03,East,D,50,30.0
2023-01-04,Central,C,90,25.0
2023-01-04,East,A,110,10.5
2023-01-05,West,E,200,8.0
2023-01-05,East,D,60,30.0
2023-01-06,Central,F,70,15.0
2023-01-06,West,E,180,8.0
2023-01-07,East,A,100,10.5
2023-01-07,Central,F,75,15.0
2023-01-08,West,B,140,12.0
2023-01-08,East,D,55,30.0
2023-01-09,Central,C,85,25.0
2023-01-09,West,E,190,8.0
2023-01-10,East,A,115,10.5
2023-01-10,Central,F,80,15.0
2023-01-11,West,B,160,12.0
2023-01-11,East,D,65,30.0
2023-01-12,Central,C,95,25.0
2023-01-12,West,E,210,8.0
2023-01-13,East,A,125,10.5
2023-01-13,Central,F,90,15.0
2023-01-14,West,B,170,12.0
2023-01-14,East,D,70,30.0
2023-01-15,Central,C,100,25.0
2023-01-15,West,E,220,8.0</code></pre>

        <div class="section-separator"></div>

        <h2>3. GitHub Actions CI/CD Workflow (<code>.github/workflows/ci.yml</code>)</h2>
        <p>A GitHub Actions push workflow is configured at <code>.github/workflows/ci.yml</code>. It runs on every push to the <code>main</code> branch, performs linting with Ruff, executes the Python script, and publishes the generated <code>result.json</code> to GitHub Pages.</p>
        <pre><code class="language-yaml">name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allows manual triggering of the workflow

permissions:
  contents: write # Needed for checkout
  pages: write    # Needed for GitHub Pages deployment
  id-token: write # Needed for GitHub Pages deployment (OIDC)

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11" # Ensure Python 3.11+ is used
          cache: 'pip' # Cache pip dependencies for faster runs

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas==2.3 ruff # Install Pandas 2.3 and Ruff

      - name: Run Ruff Linter
        run: ruff check execute.py
        continue-on-error: true # Allow CI to continue even if linter finds issues

      - name: Execute Python script and generate result.json
        run: python execute.py > result.json

      - name: Configure GitHub Pages
        uses: actions/configure-pages@v5

      - name: Upload result.json artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: 'result.json' # Upload the generated result.json

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4</code></pre>

        <div class="section-separator"></div>

        <h2>4. Generated <code>result.json</code> Output</h2>
        <p>The <code>result.json</code> file is generated by the GitHub Actions CI pipeline and published via GitHub Pages. It is <strong>not</strong> committed to the repository. The application attempts to fetch the live <code>result.json</code> from the GitHub Pages URL. If not found or an error occurs, an example of the expected output is displayed.</p>
        <div id="result-json-output" class="alert alert-info" role="alert">
            Loading <code>result.json</code> from GitHub Pages...
        </div>
        <pre><code class="language-json" id="result-json-code-block"></code></pre>
        <p class="mt-3">Expected GitHub Pages URL for <code>result.json</code>: <code>https://&lt;YOUR_GITHUB_USERNAME&gt;.github.io/&lt;YOUR_REPO_NAME&gt;/result.json</code></p>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/yaml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/json.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Highlight.js for all pre-existing code blocks
            hljs.highlightAll();

            const resultJsonOutputDiv = document.getElementById('result-json-output');
            const resultJsonCodeBlock = document.getElementById('result-json-code-block');

            // Construct the URL for result.json on GitHub Pages
            // This assumes result.json is at the root of the GitHub Pages deployment
            // e.g., https://<username>.github.io/<repo-name>/result.json
            const pathSegments = window.location.pathname.split('/');
            // If deployed to a subpath (e.g., repo-name), pathSegments[1] would be 'repo-name'
            // If deployed to root (e.g., user.github.io), pathSegments[1] would be empty
            const repoPath = pathSegments.length > 1 && pathSegments[1] !== '' ? `/${pathSegments[1]}` : '';
            const resultJsonUrl = `${window.location.origin}${repoPath}/result.json`;

            fetch(resultJsonUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    resultJsonOutputDiv.classList.remove('alert-info');
                    resultJsonOutputDiv.classList.add('alert-success');
                    resultJsonOutputDiv.innerHTML = `<code>result.json</code> successfully loaded from <a href="${resultJsonUrl}" target="_blank">${resultJsonUrl}</a>.`;
                    resultJsonCodeBlock.textContent = JSON.stringify(data, null, 2);
                    hljs.highlightElement(resultJsonCodeBlock); // Highlight fetched JSON
                })
                .catch(error => {
                    console.error('Error fetching result.json:', error);
                    resultJsonOutputDiv.classList.remove('alert-info');
                    resultJsonOutputDiv.classList.add('alert-warning');
                    resultJsonOutputDiv.innerHTML = `Failed to load <code>result.json</code> from GitHub Pages. This is expected if the CI/CD pipeline has not run or if the file is not yet deployed. <br>Below is an example of the expected output:`;
                    // Display the example result.json content if fetch fails
                    resultJsonCodeBlock.textContent = JSON.stringify(
                        {
                            "row_count": 30,
                            "regions": 3,
                            "top_n_products_by_revenue": [
                                {
                                    "product": "C",
                                    "revenue": 11000.0
                                },
                                {
                                    "product": "A",
                                    "revenue": 9240.0
                                },
                                {
                                    "product": "E",
                                    "revenue": 8000.0
                                }
                            ],
                            "rolling_7d_revenue_by_region": {
                                "Central": 1087.5,
                                "East": 1050.0,
                                "West": 1097.142857142857
                            }
                        }, null, 2);
                    hljs.highlightElement(resultJsonCodeBlock); // Highlight example JSON
                });
        });
    </script>
</body>
</html>